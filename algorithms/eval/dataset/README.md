# Data generation procedure.

## Unbiased sample

### `unbiased_manual_500_events.pb.txt`
Randomly sampled unbiased manual driving events.

```
 bazel run offboard/planner/ml/datasets/data_querying:pnc_data_to_qevent_json -- /media/s3/planner-ml/qevent_label_pb/*downsampled* > /tmp/raw_snippets.json
 cat /tmp/raw_snippets.json | shuf | tail -n 500 > /tmp/random_snippets.json
 bazel run offboard/eval/tools/qevent_converter -- /tmp/random_snippets.json --sim "$(pwd)/offboard/eval/dataset/unbiased_manual_500_events.pb.txt"
```

### `unbiased_manual_5000_events.pb.txt`
Randomly sampled unbiased manual driving events.

```
 bazel run offboard/planner/ml/datasets/data_querying:pnc_data_to_qevent_json -- /media/s3/planner-ml/qevent_label_pb/*downsampled* > /tmp/raw_snippets.json
 cat /tmp/raw_snippets.json | shuf | head -n 5000 > /tmp/random_snippets.json
 bazel run offboard/eval/tools/qevent_converter -- /tmp/random_snippets.json --sim "$(pwd)/offboard/eval/dataset/unbiased_manual_5000_events.pb.txt"
```



##  Hard brake.

### `hard_brake_100_events.pb.txt`

Randomly sampled 100 hard brake events.

```
 bazel run offboard/eval/tools/qevent_query -- --aggregate '[{"$match" : {"name": "control_hard_brake"}}, {"$sample": {"size": 100}}]' > /tmp/hard_brake_100_events.json
 bazel run offboard/eval/tools/qevent_converter -- /tmp/hard_brake_100_events.json --sim "$(pwd)/offboard/eval/dataset/hard_brake_100_events.pb.txt"
```

### `hard_brake_5000_events.pb.txt`

Randomly sampled 5000 hard brake events.

```
 bazel run offboard/eval/tools/qevent_query -- --aggregate '[{"$match" : {"name": "control_hard_brake"}}, {"$sample": {"size": 5000}}]' > /tmp/hard_brake_5000_events.json
 bazel run offboard/eval/tools/qevent_converter -- /tmp/hard_brake_5000_events.json --sim "$(pwd)/offboard/eval/dataset/hard_brake_5000_events.pb.txt"
```


## Planner timeout

### `planner_timeout_1000_events.pb.txt`


```
bazel run offboard/eval/tools/qevent_query -- --find '{"name": "planner_timeout", "aggregatefields": {"$elemMatch": {"key": "duration", "value": { "$gt" : "0.200000"}}}}'  --limit 100000 > /tmp/planner_timeout.json
cat /tmp/planner_timeout.json  | shuf | head -n1000 > /tmp/planner_timeout_1000_events.json # Randomly sample 1000 events.
bazel run offboard/eval/tools/qevent_converter -- /tmp/planner_timeout_1000_events.json --sim "$(pwd)/offboard/eval/dataset/planner_timeout_1000_events.pb.txt"
```

### `planner_timeout_202205_532_events.pb.txt`
```
 bazel run offboard/eval/tools/qevent_query -- --find '{"name": "planner_timeout", "runname": {"$regex": "^202205.*"},  "aggregatefields": {"$elemMatch": {"key": "duration", "value": { "$gt" : "0.250000"}}}}'  --limit 10000 > /tmp/planner_timeout.json
 bazel run offboard/eval/tools/qevent_converter -- /tmp/planner_timeout.json --sim "$(pwd)/offboard/eval/dataset/planner_timeout_202205_500_events.pb.txt"
 ```

 The `planner_202205_532_snapshots` dataset is generated by the following command:

 ```
 bazel run offboard/eval/tools/qevent_converter -- /tmp/planner_timeout.json --snapshots_dir "/media/users/lidong/timing/planner_532_snapshots"
 ```

To generate snapshot from the QEvents, use the following command:

```
bazel run offboard/eval/tools/qevent_converter -- /tmp/planner_timeout_1000_events.json --snapshot_dir /hosthome/planner_snapshots_100
```

## AEB

### `aeb_100_events.pb.txt`

```
bazel run //offboard/eval/tools:qevent_converter -- $(pwd)/aeb.json --sim $(pwd)/aeb_100_events.pb.txt
```
